<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify Vaporwave Visualizer</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: transparent; /* transparent background */
    overflow: hidden;
    font-family: sans-serif;
    color: #fff;
  }

  canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  #login-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 20px;
    padding: 14px 28px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #fff;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    z-index: 10;
  }

  #login-btn:hover {
    background: rgba(255,255,255,0.2);
  }

  #instructions {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    font-size: 14px;
    color: #ccc;
    z-index: 10;
  }
</style>
</head>
<body>
<canvas id="visualizer"></canvas>
<button id="login-btn">Login with Spotify</button>
<div id="instructions">Open this URL in Chrome, login with Spotify, then use the full URL (with #access_token=â€¦) in Streamlabs Browser Source with transparency enabled.</div>

<script>
const canvas = document.getElementById("visualizer");
const ctx = canvas.getContext("2d");
let WIDTH, HEIGHT;
function resizeCanvas(){
  WIDTH = canvas.width = window.innerWidth;
  HEIGHT = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Vaporwave colors
const colors = ['#FF77FF','#FFD700','#00FFFF','#7F00FF','#FF6EC7','#00FFAA'];

// Spotify OAuth
const CLIENT_ID = 'e04e71c444284496a39133ad0d4f03d0';
const REDIRECT_URI = 'https://psykrot.github.io/audio-visualizer/'; // must match Spotify app redirect URI exactly
const SCOPES = 'user-read-currently-playing';

let accessToken = null;

// Helper: get token from URL hash
function getTokenFromHash(){
  if(window.location.hash){
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }
  return null;
}

// Login button
const loginBtn = document.getElementById("login-btn");
loginBtn.onclick = () => {
  const authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
  window.location.href = authURL;
};

// Check for token
accessToken = getTokenFromHash();
if(accessToken){
  loginBtn.style.display = 'none';
  document.getElementById('instructions').style.display = 'none';
  startVisualizer();
} else {
  console.log("No Spotify token detected. Click Login with Spotify.");
}

// Spotify API helpers
async function fetchCurrentTrack(){
  try{
    const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing',{
      headers: { 'Authorization': 'Bearer ' + accessToken }
    });
    if(response.status === 204) return null;
    return await response.json();
  }catch(e){
    console.error(e);
    return null;
  }
}

async function fetchAudioAnalysis(trackId){
  const response = await fetch(`https://api.spotify.com/v1/audio-analysis/${trackId}`,{
    headers: { 'Authorization': 'Bearer ' + accessToken }
  });
  return await response.json();
}

// Visualizer
let audioAnalysis = null;
let startTime = 0;

function drawBars(trackProgress){
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  if(!audioAnalysis) return;

  const bars = audioAnalysis.bars;
  const currentBars = bars.filter(bar => bar.start <= trackProgress);
  const maxBars = Math.min(currentBars.length, WIDTH / 10);

  for(let i=0;i<maxBars;i++){
    const bar = currentBars[i];
    const barHeight = Math.min((bar.loudness + 60) * 3, HEIGHT);
    const color = colors[i % colors.length];
    ctx.fillStyle = color;
    ctx.shadowColor = color;
    ctx.shadowBlur = 20;
    const barWidth = WIDTH / maxBars;
    ctx.fillRect(i*barWidth, HEIGHT - barHeight, barWidth*0.8, barHeight);
  }
}

function animate(){
  requestAnimationFrame(animate);
  if(!audioAnalysis || !startTime) return;
  const trackProgress = (performance.now()/1000 - startTime) % audioAnalysis.track.duration;
  drawBars(trackProgress);
}

async function startVisualizer(){
  const trackData = await fetchCurrentTrack();
  if(!trackData || !trackData.item) return alert("No track currently playing.");
  audioAnalysis = await fetchAudioAnalysis(trackData.item.id);
  startTime = performance.now()/1000 - trackData.progress_ms/1000;
  animate();

  // Poll every 5 seconds for new tracks
  setInterval(async ()=>{
    const newTrack = await fetchCurrentTrack();
    if(newTrack && newTrack.item.id !== trackData.item.id){
      audioAnalysis = await fetchAudioAnalysis(newTrack.item.id);
      startTime = performance.now()/1000 - newTrack.progress_ms/1000;
    }
  }, 5000);
}
</script>
</body>
</html>
